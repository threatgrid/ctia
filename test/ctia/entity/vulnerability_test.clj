(ns ctia.entity.vulnerability-test
  (:require [cheshire.core :as json]
            [clj-momo.test-helpers.core :as mth]
            [clojure.test :refer [deftest is join-fixtures use-fixtures]]
            [clojure.tools.reader.edn :as edn]
            [ctia.entity.vulnerability :as sut]
            [ctia.entity.vulnerability.cpe :as cpe]
            [ctia.test-helpers
             [access-control :refer [access-control-test]]
             [auth :refer [all-capabilities]]
             [core :as helpers :refer [GET]]
             [crud :refer [entity-crud-test]]
             [aggregate :refer [test-metric-routes]]
             [es :as es-helpers]
             [fake-whoami-service :as whoami-helpers]
             [http :refer [app->APIHandlerServices]]
             [store :refer [test-for-each-store-with-app]]]
            [ctim.examples.vulnerabilities :refer [new-vulnerability-maximal new-vulnerability-minimal]]))

(use-fixtures :once
  (join-fixtures [mth/fixture-schema-validation
                  whoami-helpers/fixture-server]))

(def enabled-stores #{:tool :vulnerability :attack-pattern :incident :casebook :malware})

(deftest test-vulnerability-routes
  (test-for-each-store-with-app
   enabled-stores
   (fn [app]
     (helpers/set-capabilities! app
                                "foouser"
                                ["foogroup"]
                                "user"
                                all-capabilities)
     (whoami-helpers/set-whoami-response app
                                         "45c1f5e3f05d0"
                                         "foouser"
                                         "foogroup"
                                         "user")
     (entity-crud-test
      (into sut/vulnerability-entity
            {:app app
             :example new-vulnerability-maximal
             :headers {:Authorization "45c1f5e3f05d0"}})))))

(deftest test-vulnerability-routes-access-control
  (access-control-test "vulnerability"
                       new-vulnerability-minimal
                       true
                       true
                       (partial test-for-each-store-with-app enabled-stores)))

(deftest test-vulnerability-metric-routes
  (test-metric-routes enabled-stores
                      (into sut/vulnerability-entity
                            {:entity-minimal new-vulnerability-minimal
                             :enumerable-fields sut/vulnerability-enumerable-fields
                             :date-fields sut/vulnerability-histogram-fields})))

(deftest test-build-configurations-query
  (is (= (sut/build-configurations-query (map cpe/->cpe-match ["cpe:2.3:o:juniper:advanced_threat_prevention:*:*:*:*:*:*:*:*"
                                                               "cpe:2.3:h:juniper:atp400:-:*:*:*:*:*:*:*"]))
         "configurations.nodes.cpe_match.cpe23Uri:cpe\\:2.3\\:o\\:juniper\\:advanced_threat_prevention* OR configurations.nodes.children.cpe_match.cpe23Uri:cpe\\:2.3\\:o\\:juniper\\:advanced_threat_prevention* OR configurations.nodes.cpe_match.cpe23Uri:cpe\\:2.3\\:h\\:juniper\\:atp400* OR configurations.nodes.children.cpe_match.cpe23Uri:cpe\\:2.3\\:h\\:juniper\\:atp400*")))

(deftest search-by-cpe-match-strings-test
  (helpers/fixture-ctia-with-app
   (fn [app]
     (helpers/set-capabilities! app "foouser" ["foogroup"] "user" all-capabilities)
     (whoami-helpers/set-whoami-response app "45c1f5e3f05d0" "foouser" "foogroup" "user")
     (let [{{get-store :get-store} :StoreService} (app->APIHandlerServices app)
           {{conn :conn} :state :as store} (get-store :vulnerability)
           _ (es-helpers/load-file-bulk app conn "./test/data/indices/sample-vulnerability-150.json")
           _ (Thread/sleep 1000)
           cpe-match-strings ["cpe:2.3:h:juniper:ex8200\\/vc_\\(xre\\):-:*:*:*:*:*:*:*"
                              "cpe:2.3:o:juniper:junos:14.1x53:*:*:*:*:*:*:*"]
           vulnerability-ids (sut/vulnerability-ids-affected-by-cpe-matches
                              {:cpe-matches (map cpe/->cpe-match cpe-match-strings)
                               :store store})
           response (GET app
                         "/ctia/vulnerability/cpe_match_strings"
                         :query-params {:cpe23_match_strings cpe-match-strings}
                         :headers {:Authorization "45c1f5e3f05d0"})]
       (is (not (realized? vulnerability-ids)))
       (is (= 200 (:status response)))
       (is (= #{"CVE-2018-0007" "CVE-2018-0024" "CVE-2018-0031"}
              (set (map :title (edn/read-string (:body response))))))))))

(deftest cpe-match-strings-paging-test
  (helpers/fixture-ctia-with-app
   (fn [app]
     (helpers/set-capabilities! app "foouser" ["foogroup"] "user" all-capabilities)
     (whoami-helpers/set-whoami-response app "45c1f5e3f05d0" "foouser" "foogroup" "user")
     (let [{{get-store :get-store} :StoreService} (app->APIHandlerServices app)
           {{conn :conn} :state} (get-store :vulnerability)
           _ (es-helpers/load-file-bulk app conn "./test/data/indices/sample-cpe-250.json")
           _ (Thread/sleep 1000)
           cpe-match-strings ["cpe:2.3:a:microsoft:edge:-:*:*:*:*:*:*:*"]
           results (loop [acc []
                          x-sort nil
                          x-total-hits []]
                     (let [{parsed-body :parsed-body {:strs [X-Sort X-Total-Hits]} :headers}
                           (GET app
                                "/ctia/vulnerability/cpe_match_strings"
                                :query-params (if x-sort
                                                {:cpe23_match_strings cpe-match-strings
                                                 "search_after" x-sort}
                                                {:cpe23_match_strings cpe-match-strings})
                                :headers {:Authorization "45c1f5e3f05d0"})]
                       (if-let [next-x-sort (first (json/decode X-Sort))]
                         (recur (concat acc parsed-body)
                                next-x-sort
                                (conj x-total-hits X-Total-Hits))
                         {:body (concat acc parsed-body)
                          :x-total-hits (conj x-total-hits X-Total-Hits)})))]
       (is (= 250 (count (:body results)))
           "Should retrieve all the results.")
       (is (= ["100" "100" "50" "0"]
              (:x-total-hits results))
           "Should retrieve three pages of data with a default page size of 100")))))

