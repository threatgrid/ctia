(ns cia.schemas.exploit-target
  (:require [cia.schemas.common :as c]
            [cia.schemas.relationships :as rel]
            [cia.schemas.vocabularies :as v]
            [schema.core :as s]
            [schema-tools.core :as st]))

(s/defschema Vulnerability
  "See http://stixproject.github.io/data-model/1.2/et/VulnerabilityType/"
  {

   :title (describe s/Str "title for this vulnerability")
   :description (describe s/Str "title for this vulnerability")
   (s/optional-key :is_known)
   (describe s/Bool "whether or not the vulnerability is known (i.e. not a 0-day) at the time of characterization.")
   (s/optional-key :is_public_acknowledged)
   (describe s/Bool "whether or not the vulnerability is publicly acknowledged by the vendor")
   (s/optional-key :short_description)
   (describe s/Str "short text description of this vulnerability")
   (s/optional-key :cve_id)
   (describe s/Str "CVE identifier")
   (s/optional-key :osvdb_id)
   (describe s/Int "OSVDB identifier")
   (s/optional-key :source)
   (describe s/Str "the source of the CVE or OSVDB as a textual description or URL") ; source of CVE or OSVDB ref
   (s/optional-key :discovered_datetime)
   (describe c/Time "date and time that this vulnerability was first discovered") ; Simplified
   (s/optional-key :published_datetime)
   (describe c/Time "date and time that this vulnerability was first published") ; Simplified
   ;; TODO - :affected_software below is greatly simplified, should it be expanded?
   (s/optional-key :affected_software)
   (describe [s/Str] "list of platforms and software that are affected by this vulnerability")
   (s/optional-key :references)
   (describe [c/URI] "list of external references describing this vulnerability")
   ;; Not provided: CVSS_Score ; Should it be?
   })

(s/defschema Weakness
  "See http://stixproject.github.io/data-model/1.2/et/WeaknessType/"
  {:description (describe s/Str "text description of this Weakness")
   (s/optional-key :cwe_id)
   (describe s/Str "CWE identifier") ;; CWE identifier for a particular weakness
   })

(s/defschema Configuration
  "See http://stixproject.github.io/data-model/1.2/et/ConfigurationType/"
  {:description (describe s/Str "text description of this Configuration")
   (s/optional-key :short_description)
   (describe s/Str "short text description of this Configuration")
   (s/optional-key :cce_id)
   (describe s/Str "CCE identifier") ;; The CCE identifier for a configuration item
   })

(s/defschema ExploitTarget
  "See http://stixproject.github.io/data-model/1.2/et/ExploitTargetType/"
  (st/merge
   c/GenericStixIdentifiers
   {:timestamp c/Time
    (s/optional-key :version)
    (describe s/Str "schema version for this content")
    (s/optional-key :vulnerability)
    (describe [Vulnerability] "identifies and characterizes a Vulnerability as a potential ExploitTarget")
    (s/optional-key :weakness)
    (describe [Weakness] "identifies and characterizes a Weakness as a potential ExploitTarget")
    (s/optional-key :configuration)
    (describe [Configuration] "identifies and characterizes a Configuration as a potential ExploitTarget")
    (s/optional-key :potential_COAs)
    (describe rel/RelatedCOAs "identifies and characterizes a Configuration as a potential ExploitTarget")
    (s/optional-key :source)
    (describe c/Source "ExploitTarget source")
    (s/optional-key :related_exploit_targets)
    (describe rel/RelatedExploitTargets "identifies and characterizes a Configuration as a potential ExploitTarget")

    ;; Not provided: related_packages (deprecated)
    ;; Not provided: handling
    }))

(s/defschema NewExploitTarget
  "Schema for submitting ExploitTargets"
  (st/dissoc ExploitTarget
             :id))

(s/defn realize-exploit-target :- ExploitTarget
  [new-exploit-target :- NewExploitTarget
   id :- s/Str]
  (assoc new-exploit-target
         :id id))
